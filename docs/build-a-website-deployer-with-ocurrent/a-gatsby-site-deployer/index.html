<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head><title>A Gatsby Site Deployer</title><meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description"
   content="Setup the entry point of the pipeline to watch Github and pull from it to get the latest content"
   />
  <link rel="stylesheet" href="/styles.css"/>
 </head>
 <body>
             
  <div class="nav"><h1 class="title"><a href="/">OCurrent Doc</a></h1>
   <ul>
    <li>
     <a href="/introduction-to-incrementalism-in-ocurrent">
      Introduction to incrementalism in OCurrent
     </a>
     <ul>
      <li>
       <a
        href="/introduction-to-incrementalism-in-ocurrent/the-domain-specific-language"
        >The Domain Specific Language
       </a>
      </li>
      <li>
       <a
        href="/introduction-to-incrementalism-in-ocurrent/a-high-level-interface"
        >A High Level Interface
       </a>
      </li>
      <li>
       <a href="/introduction-to-incrementalism-in-ocurrent/using-plugins">
        Using plugins
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="/build-a-website-deployer-with-ocurrent">
      Build a website deployer with OCurrent
     </a>
     <ul>
      <li>
       <a
        href="/build-a-website-deployer-with-ocurrent/a-gatsby-site-deployer">
        A Gatsby Site Deployer
       </a>
      </li>
     </ul>
    </li>
    <li><a href="/create-an-ocurrent-plugin">Create an OCurrent Plugin</a>
     <ul>
      <li>
       <a href="/create-an-ocurrent-plugin/basic-ocurrent-primitives">
        Basic OCurrent Primitives
       </a>
      </li>
      <li>
       <a href="/create-an-ocurrent-plugin/build-a-gitlab-ocurrent-plugin">
        Build a Gitlab OCurrent Plugin
       </a>
      </li>
     </ul>
    </li>
    <li><a href="/ocluster">OCluster</a>
     <ul>
      <li>
       <a href="/ocluster/capabilities-and-protocols-or-something">
        Capabilities and protocols or something
       </a>
      </li>
      <li>
       <a href="/ocluster/a-scheduler,-some-workers-and-a-client">
        A scheduler, some workers and a client
       </a>
      </li>
     </ul>
    </li>
    <li><a href="/obuilder">OBuilder</a>
     <ul>
      <li>
       <a href="/obuilder/platform-agnostic-build-environments">
        Platform agnostic build environments
       </a>
      </li>
     </ul>
    </li>
   </ul>
  </div>
  <div class="content">
   <div class="meta"><h2>A Gatsby Site Deployer</h2>
    <p> By Patrick Ferris on 2020-11-21 00:02:33 +00:00</p>
   </div>
   <details><summary>Table of Contents</summary>
    <ul class="toc">
     <li>
      <ul class="toc">
       <li>
        <ul class="toc">
         <li class="toc-li">
          <a class="toc-link toc-item-2" href="#authentication">
           Authentication
          </a>
         </li>
        </ul>
        <ul class="toc">
         <li>
          <a class="toc-link toc-item-2" href="#fetching-your-repository">
           Fetching your repository
          </a>
          <ul class="toc">
           <li class="toc-li">
            <a class="toc-link toc-item-3" href="#a-note-on-caching">
             A Note on Caching
            </a>
           </li>
          </ul>
         </li>
        </ul>
        <ul class="toc">
         <li class="toc-li">
          <a class="toc-link toc-item-2" href="#building-with-docker">
           Building with Docker
          </a>
         </li>
        </ul>
        <ul class="toc">
         <li class="toc-li">
          <a class="toc-link toc-item-2" href="#the-final-pipeline">
           The Final Pipeline
          </a>
         </li>
        </ul>
        <ul class="toc">
         <li class="toc-li">
          <a class="toc-link toc-item-2" href="#wrapping-it-up-as-a-cli-tool">
           Wrapping it up as a CLI tool
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
   </details>
   <p>The first part of our pipeline is to pull content from Github. OCurrent is in now way limited to Github, but it is the only backend currently supported. So that's what we'll use.</p>
<h2 id="authentication">Authentication</h2>
<p>In order to pull things from Github we'll have to authenticate in order to use the Github API. You will want to go to your profile <code>Settings &gt; Developer Settings &gt; Personal Access Tokens</code>.  Next you will want to generate a new token with support for access to your public repositories.</p>
<h2 id="fetching-your-repository">Fetching your repository</h2>
<p>We're almost done believe it or not! The next step is to actually use the OCurrent Github plugin (<code>Current_github</code>) to fetch the head commit of the main branch (<code>ref</code>).</p>
<!-- $MDX file=./deployer/deployer.ml,part=0 -->
<pre><code><span class="ocaml-keyword">module</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Gh</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_github</span><span class="ocaml-source">
</span><span class="ocaml-keyword">module</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Git</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_git</span><span class="ocaml-source">
</span><span class="ocaml-keyword">module</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Docker</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_docker</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Default</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">let </span><span class="ocaml-entity-name">fetch</span><span class="ocaml-source"> </span><span class="ocaml-source">~</span><span class="ocaml-source">github</span><span class="ocaml-source"> ~</span><span class="ocaml-source">repo</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">head</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Gh</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Api</span><span class="ocaml-keyword">.</span><span class="ocaml-source">head_commit</span><span class="ocaml-source"> </span><span class="ocaml-source">github</span><span class="ocaml-source"> </span><span class="ocaml-source">repo</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-source">map</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Gh</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Api</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Commit</span><span class="ocaml-keyword">.</span><span class="ocaml-source">id</span><span class="ocaml-source"> </span><span class="ocaml-source">head</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Git</span><span class="ocaml-keyword">.</span><span class="ocaml-source">fetch</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source">
</span></code></pre><p>The <code>~github</code> parameter is our <em>Api</em> value, we won't have to generate this as you will see later. And <code>~repo</code> is our repository which will eventually be in the form <code>username/repo</code> which the user can specify from the command-line.</p>
<p>We first get the head of the repository using the <code>Api</code>'s exposed functionality and pull out the unique id using the <code>Current.map</code> function. Now we use the <code>Git</code> plugin to actually go get the specific head commit.</p>
<p>If we look at the <a href="https://github.com/ocurrent/ocurrent/blob/master/plugins/github/api.ml#L314">plugin code</a> we can see that it defines a new component. This is what we see in the generated dependency graph. Not only that, but it is being <strong>monitored</strong> which allows OCurrent to propagate new values when the head commit changes (like if a new commit is pushed).</p>
<h3 id="a-note-on-caching">A Note on Caching</h3>
<p>One of the big benefits of OCurrent pipelines is a smart use of caching. Luckily a lot of the plugins give you this out of the box. For example, the <code>Git.fetch</code> function is backed by the <a href="https://github.com/ocurrent/ocurrent/blob/master/plugins/git/current_git.ml#L52">fetch cache</a>. In the next tutorial on writing plugins we'll look at this more deeply, but you can see that the functor to a build a cache is relatively simple.</p>
<pre><code><span class="ocaml-keyword">#</span><span class="ocaml-source"> </span><span class="ocaml-keyword">#</span><span class="ocaml-source">require</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">current.cache</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-keyword">#</span><span class="ocaml-source"> </span><span class="ocaml-keyword">#</span><span class="ocaml-source">show</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_cache</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">S</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">BUILDER</span><span class="ocaml-source">
</span><span class="ocaml-keyword">module</span><span class="ocaml-source"> </span><span class="ocaml-keyword">type</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">BUILDER</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">sig</span><span class="ocaml-source">
</span><span class="ocaml-source">    type t
</span><span class="ocaml-source">    val id : string
</span><span class="ocaml-source">    module Key : Current_cache.S.WITH_DIGEST
</span><span class="ocaml-source">    module Value : Current_cache.S.WITH_MARSHAL
</span><span class="ocaml-source">    val build : t -&gt; Current.Job.t -&gt; Key.t -&gt; Value.t Current.or_error Lwt.t
</span><span class="ocaml-source">    val pp : Key.t Fmt.t
</span><span class="ocaml-source">    val auto_cancel : bool
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">end</span><span class="ocaml-source">
</span></code></pre><h2 id="building-with-docker">Building with Docker</h2>
<p>In order to build and run are Gatsby site we'll need two docker images:</p>
<ul>
<li>A <em>build</em> image in order to run <code>gatsby build</code> -- this will need NodeJS and yarn installed. We will use <code>node:12-buster</code> for this.
</li>
<li>A <em>server</em> image with OCaml and opam installed. We will use <code>ocaml/opam:alpine-ocaml-4.11</code> for this, which is pushed to docker hub using an OCurrent pipeline!
</li>
</ul>
<p>The build process is quite simple:</p>
<ol>
<li>Pull the docker images
</li>
<li>Write a dockerfile in OCaml
</li>
<li>Build the Dockerfile using the git repository we got earlier
</li>
<li>Run the image we built
</li>
</ol>
<p>Thankfully, we can use the <a href="https://github.com/ocurrent/ocurrent/tree/master/plugins/docker">Docker plugin</a> for all of this.</p>
<!-- $MDX file=./deployer/deployer.ml,part=2 -->
<pre><code><span class="ocaml-source">let </span><span class="ocaml-entity-name">build</span><span class="ocaml-source"> </span><span class="ocaml-source">~</span><span class="ocaml-source">src</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">let </span><span class="ocaml-keyword">open</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Dockerfile</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">dockerfile</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword">let</span><span class="ocaml-keyword">+ </span><span class="ocaml-entity-name">builder</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-source">pull</span><span class="ocaml-source"> ~</span><span class="ocaml-source">schedule</span><span class="ocaml-source"> </span><span class="ocaml-source">gatsby_builder</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword">and</span><span class="ocaml-keyword">+ </span><span class="ocaml-entity-name">server</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-source">pull</span><span class="ocaml-source"> ~</span><span class="ocaml-source">schedule</span><span class="ocaml-source"> </span><span class="ocaml-source">gatsby_server</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">from</span><span class="ocaml-source"> ~</span><span class="ocaml-source">alias</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">build</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Image</span><span class="ocaml-keyword">.</span><span class="ocaml-source">hash</span><span class="ocaml-source"> </span><span class="ocaml-source">builder</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">workdir</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">/app</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">yarn global add gatsby-cli</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">copy</span><span class="ocaml-source"> ~</span><span class="ocaml-source">src</span><span class="ocaml-keyword">:</span><span class="ocaml-source">[</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">package.json</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">]</span><span class="ocaml-source"> ~</span><span class="ocaml-source">dst</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">.</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">yarn</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">copy</span><span class="ocaml-source"> ~</span><span class="ocaml-source">src</span><span class="ocaml-keyword">:</span><span class="ocaml-source">[</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">.</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">]</span><span class="ocaml-source"> ~</span><span class="ocaml-source">dst</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">.</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">gatsby build</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">from</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Image</span><span class="ocaml-keyword">.</span><span class="ocaml-source">hash</span><span class="ocaml-source"> </span><span class="ocaml-source">server</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">sudo apk update &amp;&amp; sudo apk add m4</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">opam install cohttp-lwt-unix</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">copy</span><span class="ocaml-source"> ~</span><span class="ocaml-source">from</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">build</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> ~</span><span class="ocaml-source">src</span><span class="ocaml-keyword">:</span><span class="ocaml-source">[</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">/app/public</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">]</span><span class="ocaml-source"> ~</span><span class="ocaml-source">dst</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">/pub</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">workdir</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">/pub</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">expose_port</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric">8000</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">cmd</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">opam exec -- cohttp-server-lwt -p 8000 -s 0.0.0.0</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-keyword">fun</span><span class="ocaml-source"> </span><span class="ocaml-source">d</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">`Contents</span><span class="ocaml-source"> </span><span class="ocaml-source">d</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-source">build</span><span class="ocaml-source"> ~</span><span class="ocaml-source">pull</span><span class="ocaml-keyword">:</span><span class="ocaml-constant-language">false</span><span class="ocaml-source"> ~</span><span class="ocaml-source">dockerfile</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">`Git</span><span class="ocaml-source"> </span><span class="ocaml-source">src</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span></code></pre><p>We're using the <a href="https://github.com/avsm/ocaml-dockerfile">Dockerfile</a> eDSL for writing Dockerfiles in OCaml which almost reads like a normal file. Using the Docker plugin's <code>pull</code> function we get both image and &quot;expose&quot; their values using the <code>let+</code> syntax. With <code>Docker.Image.hash</code> we use the hash version of the docker image which will be more reproducible than simply the name of the image.</p>
<p>After that it should be mostly straightforward:</p>
<ul>
<li>In the build image we copy in the <code>package.json</code> to install the write dependencies, then we copy in the main site and run <code>gatsby build</code> which outputs the website in <code>/app/public</code>.
</li>
<li>In the server image we install <code>cohttp-lwt-unix</code> to get the server and the copy the site from the build into <code>/pub</code>. We expose port <code>8000</code> and run the server on that port with host <code>0.0.0.0</code>. This will allows us to see the server running at <code>localhost:8000</code>.
</li>
</ul>
<p>One aspect to make note of is the <code>schedule</code> parameter. We build this using the <code>Current_cache</code> module.</p>
<!-- $MDX file=./deployer/deployer.ml,part=1 -->
<pre><code><span class="ocaml-source">let </span><span class="ocaml-entity-name">schedule</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_cache</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Schedule</span><span class="ocaml-keyword">.</span><span class="ocaml-source">v</span><span class="ocaml-source"> ~</span><span class="ocaml-source">valid_for</span><span class="ocaml-keyword">:</span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Duration</span><span class="ocaml-keyword">.</span><span class="ocaml-source">of_day</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric">7</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">let </span><span class="ocaml-entity-name">gatsby_builder</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">node:12-buster</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">let </span><span class="ocaml-entity-name">gatsby_server</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">ocaml/opam:alpine-ocaml-4.11</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span></code></pre><p>This tells our pipeline how often we should re-pull our Docker images.</p>
<h2 id="the-final-pipeline">The Final Pipeline</h2>
<!-- $MDX file=./deployer/deployer.ml,part=3 -->
<pre><code><span class="ocaml-source">let </span><span class="ocaml-entity-name">pipeline</span><span class="ocaml-source"> </span><span class="ocaml-source">~</span><span class="ocaml-source">github</span><span class="ocaml-source"> ~</span><span class="ocaml-source">repo</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">src</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-source">fetch</span><span class="ocaml-source"> ~</span><span class="ocaml-source">github</span><span class="ocaml-source"> ~</span><span class="ocaml-source">repo</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">image</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-source">build</span><span class="ocaml-source"> ~</span><span class="ocaml-source">src</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Docker</span><span class="ocaml-keyword">.</span><span class="ocaml-source">run</span><span class="ocaml-source"> </span><span class="ocaml-source">image</span><span class="ocaml-source"> ~</span><span class="ocaml-source">run_args</span><span class="ocaml-keyword">:</span><span class="ocaml-source">[</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">-p=8000:8000</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">]</span><span class="ocaml-source"> ~</span><span class="ocaml-source">args</span><span class="ocaml-keyword">:</span><span class="ocaml-constant-language">[]</span><span class="ocaml-source">
</span></code></pre><p>Our pipeline reuses the <code>fetch</code> and <code>build</code> we have already looked at. We pull that altogether in our <code>pipeline</code> function and run the Docker image we produced (with the additional port mapping parameter).</p>
<p>The last step is to wrap this pipeline up in the <code>Current.Engine</code> which we can run in a thread alongside a website for viewing our pipeline in action. The website just needs a <code>route list</code> which can be automatically generated from our <code>engine</code> value.</p>
<p>We then run this inside the main <code>lwt</code> thread. You could also use <a href="https://github.com/ocurrent/ocurrent/blob/master/examples/logging.ml#L36">this logging function</a> if you want more information printed to the console.</p>
<!-- $MDX file=./deployer/deployer.ml,part=4 -->
<pre><code><span class="ocaml-source">let </span><span class="ocaml-entity-name">main</span><span class="ocaml-source"> </span><span class="ocaml-source">config</span><span class="ocaml-source"> </span><span class="ocaml-source">mode</span><span class="ocaml-source"> </span><span class="ocaml-source">github</span><span class="ocaml-source"> </span><span class="ocaml-source">repo</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">engine</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Engine</span><span class="ocaml-keyword">.</span><span class="ocaml-source">create</span><span class="ocaml-source"> ~</span><span class="ocaml-source">config</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-source">pipeline</span><span class="ocaml-source"> ~</span><span class="ocaml-source">github</span><span class="ocaml-source"> ~</span><span class="ocaml-source">repo</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">routes</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_web</span><span class="ocaml-keyword">.</span><span class="ocaml-source">routes</span><span class="ocaml-source"> </span><span class="ocaml-source">engine</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">site</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-constant-language">Current_web</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Site</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">v</span><span class="ocaml-source"> ~</span><span class="ocaml-source">has_role</span><span class="ocaml-keyword">:</span><span class="ocaml-source">allow_all</span><span class="ocaml-source">)</span><span class="ocaml-source"> ~</span><span class="ocaml-source">name</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">gatsby_deployer</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">routes</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Lwt_main</span><span class="ocaml-keyword">.</span><span class="ocaml-source">run</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Lwt</span><span class="ocaml-keyword">.</span><span class="ocaml-source">choose</span><span class="ocaml-source"> </span><span class="ocaml-source">[</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Engine</span><span class="ocaml-keyword">.</span><span class="ocaml-source">thread</span><span class="ocaml-source"> </span><span class="ocaml-source">engine</span><span class="ocaml-keyword">;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_web</span><span class="ocaml-keyword">.</span><span class="ocaml-source">run</span><span class="ocaml-source"> ~</span><span class="ocaml-source">mode</span><span class="ocaml-source"> </span><span class="ocaml-source">site</span><span class="ocaml-source"> </span><span class="ocaml-source">]</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span></code></pre><h2 id="wrapping-it-up-as-a-cli-tool">Wrapping it up as a CLI tool</h2>
<p>The final stage is to bring our pipeline together and use <a href="https://erratique.ch/software/cmdliner/doc/Cmdliner">Cmdliner</a> to produce a useful CLI tool.</p>
<!-- $MDX file=./deployer/deployer.ml,part=5 -->
<pre><code><span class="ocaml-comment">(*</span><span class="ocaml-comment"> Command-line parsing </span><span class="ocaml-comment">*)</span><span class="ocaml-source">
</span><span class="ocaml-keyword">open</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Cmdliner</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">let </span><span class="ocaml-entity-name">repo</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Arg</span><span class="ocaml-keyword">.</span><span class="ocaml-source">required</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Arg</span><span class="ocaml-keyword">.</span><span class="ocaml-source">pos</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric">0</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Arg</span><span class="ocaml-keyword">.</span><span class="ocaml-source">some</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Gh</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Repo_id</span><span class="ocaml-keyword">.</span><span class="ocaml-source">cmdliner</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">None</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Arg</span><span class="ocaml-keyword">.</span><span class="ocaml-source">info</span><span class="ocaml-source"> ~</span><span class="ocaml-source">doc</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">The GitHub repository (owner/name) to monitor.</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> ~</span><span class="ocaml-source">docv</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">REPO</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">       </span><span class="ocaml-constant-language">[]</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">let </span><span class="ocaml-entity-name">cmd</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">doc</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">Monitor a GitHub repository containing a Gatsby site.</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">(</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Term</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">
</span><span class="ocaml-source">      </span><span class="ocaml-source">const</span><span class="ocaml-source"> </span><span class="ocaml-source">main</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">$</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Config</span><span class="ocaml-keyword">.</span><span class="ocaml-source">cmdliner</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">$</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Current_web</span><span class="ocaml-keyword">.</span><span class="ocaml-source">cmdliner</span><span class="ocaml-source">
</span><span class="ocaml-source">      </span><span class="ocaml-keyword-operator">$</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Gh</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Api</span><span class="ocaml-keyword">.</span><span class="ocaml-source">cmdliner</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">$</span><span class="ocaml-source"> </span><span class="ocaml-source">repo</span><span class="ocaml-source">)</span><span class="ocaml-keyword">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-constant-language">Term</span><span class="ocaml-keyword">.</span><span class="ocaml-source">info</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">gatsby_deployer</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> ~</span><span class="ocaml-source">doc</span><span class="ocaml-source"> </span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-keyword">let</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Term</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">exit</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">@@</span><span class="ocaml-source"> </span><span class="ocaml-source">eval</span><span class="ocaml-source"> </span><span class="ocaml-source">cmd</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span></code></pre><p>We can use the predefined arguments that the various <code>Current</code> module provide which add flags like <code>port</code> mapping. The only one we do provide is the <code>repo</code> parameter to specify which repository on Github we want to pull. We will also need to provide the authentication token from the beginning by pasting it into a file (here <code>.token</code>).</p>
<pre><code>deployer --github-token-file=./.token patricoferris/gatsby-starter-default
</code></pre>
<p>And that's it! After running your pipeline go to <code>localhost:8080</code> to see your pipeline in action. Once it get's to the <code>run</code> component you should be able to go to <code>localhost:8000</code> and see your Gatsby site built and deployed on a Cohttp server!</p>

   <ol></ol>
  </div>
            
            
          
 </body>
</html>